<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üõç Simple Shop</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Quick styling for layout */
      body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
      header { background: #4caf50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
      nav button { margin-left: 10px; padding: 5px 10px; cursor: pointer; }
      section { padding: 20px; }
      .products { display: flex; flex-wrap: wrap; gap: 20px; }
      /* Modal styles */
      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
      .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 8px; position: relative; }
      .close-modal { position: absolute; right: 10px; top: 10px; font-size: 24px; cursor: pointer; }
      .product-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 200px; }
      .product-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
      .product-details h3 { margin: 10px 0 5px 0; font-size: 1.1em; }
      .price { font-weight: bold; color: #e91e63; }
      .auth input, .add-product input { display: block; width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
      .auth-buttons button { margin-right: 10px; padding: 8px 12px; }
      footer { text-align: center; padding: 10px; background: #222; color: white; margin-top: 20px; }
      .error { color: red; }
    </style>
  </head>
  <body>
    <header>
      <h1>üõç Simple Shop</h1>
      <nav>
        <button onclick="window.location.href='index.html'">Home</button>
        <button onclick="window.location.href='cart.html'">Cart</button>
        <button onclick="window.location.href='payment.html'">Payment</button>
        <button onclick="window.location.href='review.html'">Reviews</button>
        <button onclick="logout()">Logout</button>
      </nav>
    </header>

    <section class="auth-section">
      <h2>Login / Signup</h2>
      <div class="auth">
        <input type="text" id="name" placeholder="Full Name (for Signup)" />
        <input type="text" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <div class="auth-buttons">
          <button onclick="login()">Login</button>
          <button onclick="signup()">Signup</button>
        </div>
      </div>
    </section>

    <section>
      <h2>Products</h2>
      <div id="productList" class="products"></div>
    </section>

    <section class="admin" id="adminSection" style="display: none;">
      <h2>Admin: Add Product</h2>
      <div class="add-product">
        <input type="text" id="pname" placeholder="Product Name" />
        <input type="text" id="pimage" placeholder="Image URL (optional)" />
        <input type="number" id="pprice" placeholder="Price (‚Çπ)" />
        <input type="number" id="pstock" placeholder="Stock" />
        <input type="text" id="pdesc" placeholder="Description" />
        <button onclick="addProduct()">Add Product</button>
      </div>
    </section>

    <footer>
      <p>¬© 2025 Simple Shop | Built by Yashwanth Raj KS</p>
    </footer>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h2>Edit Product</h2>
        <div class="edit-product-form">
          <input type="text" id="editName" placeholder="Product Name" />
          <input type="text" id="editImage" placeholder="Image URL" />
          <input type="number" id="editPrice" placeholder="Price (‚Çπ)" />
          <input type="number" id="editStock" placeholder="Stock" />
          <input type="text" id="editDesc" placeholder="Description" />
          <button onclick="saveProductEdit()">Save Changes</button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5000/api";
      let token = localStorage.getItem("token") || "";
      let userRole = localStorage.getItem("userRole") || "";

      async function signup() {
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        if (!name || !email || !password) return alert("Please fill all fields.");
        
        try {
          const res = await fetch(`${API_BASE}/auth/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password }),
          });
          const data = await res.json();
          alert(data.message || "Signup successful! Please login.");
        } catch (err) {
          alert("Signup failed. Try again.");
          console.error(err);
        }
      }

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        if (!email || !password) return alert("Please enter email and password.");

        try {
          const res = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (data.token) {
            token = data.token;
            userRole = data.user.role;
            localStorage.setItem("token", token);
            localStorage.setItem("userRole", userRole);
            alert(`Welcome ${data.user.name || data.user.email}!`);
            loadProducts();
            if (userRole === "admin") document.getElementById("adminSection").style.display = "block";
          } else {
            alert(data.message || "Login failed");
          }
        } catch (err) {
          alert("Login failed. Try again.");
          console.error(err);
        }
      }

      async function loadProducts() {
        const productList = document.getElementById("productList");
        try {
          const res = await fetch(`${API_BASE}/products`);
          const products = await res.json();
          
          productList.innerHTML = products.map(p => {
            // Prefer stored image URL; fallback to mapping/default
            let imgPath = p.image || './images/default.jpg';
            const nameLower = p.name.toLowerCase();
            if (!p.image) {
              if (nameLower.includes("airpods")) imgPath = "./images/airpods.jpg";
              else if (nameLower.includes("fitbit")) imgPath = "./images/fitbit.jpg";
              else if (nameLower.includes("iphone")) imgPath = "./images/iphone.jpg";
              else if (nameLower.includes("sony")) imgPath = "./images/sony.jpg";
            }

            // Admin edit/delete buttons
            const adminControls = (userRole === 'admin') ? `
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button onclick="editProduct('${p._id}')">Edit</button>
                <button onclick="deleteProduct('${p._id}')">Delete</button>
              </div>
            ` : '';

            return `
              <div class="product-card" data-id="${p._id}">
                <div class="img-container">
                  <img src="${imgPath}" alt="${p.name}" class="product-image" loading="lazy" width="200" height="200" onerror="this.src='./images/default.jpg'">
                </div>
                <div class="product-details">
                  <h3>${p.name}</h3>
                  <p class="price">‚Çπ${p.price}</p>
                  <p>Stock: ${p.stock || 0}</p>
                  <p class="desc">${p.description || ""}</p>
                  <button onclick="addToCart('${p._id}')">Add to Cart</button>
                  ${adminControls}
                </div>
              </div>
            `;
          }).join("");
        } catch (err) {
          console.error(err);
          productList.innerHTML = '<p class="error">Failed to load products. Please try again.</p>';
        }
      }

      async function addProduct() {
        token = localStorage.getItem("token") || token;
        if (userRole !== "admin") return alert("Only admin can add products!");

          const name = document.getElementById("pname").value;
          const image = document.getElementById("pimage").value || '';
          const price = document.getElementById("pprice").value;
          const stock = document.getElementById("pstock").value;
          const description = document.getElementById("pdesc").value;

        try {
          const res = await fetch(`${API_BASE}/products`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
              body: JSON.stringify({ name, price, stock, description, image }),
          });
          const data = await res.json();
            alert(data.message || "Product added successfully!");
          loadProducts();
        } catch (err) {
          alert("Failed to add product.");
          console.error(err);
        }
      }

      // Admin: delete product
      async function deleteProduct(productId) {
        if (!confirm('Delete this product?')) return;
        token = localStorage.getItem('token') || token;
        try {
          const res = await fetch(`${API_BASE}/products/${productId}`, {
            method: 'DELETE',
            headers: { Authorization: 'Bearer ' + token }
          });
          const data = await res.json();
          alert(data.message || 'Product deleted');
          loadProducts();
        } catch (err) {
          console.error(err);
          alert('Failed to delete product');
        }
      }

      // Modal functions
      function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
      }

      let currentEditId = '';

      // Admin: edit product with modal
      function editProduct(productId) {
        currentEditId = productId;
        const product = document.querySelector(`[data-id="${productId}"]`);
        
        // Pre-fill the form
        document.getElementById('editName').value = product.querySelector('h3').textContent;
        document.getElementById('editImage').value = product.querySelector('img').src;
        document.getElementById('editPrice').value = product.querySelector('.price').textContent.replace('‚Çπ', '');
        document.getElementById('editStock').value = product.querySelector('p').textContent.replace('Stock: ', '');
        document.getElementById('editDesc').value = product.querySelector('.desc').textContent;
        
        // Show modal
        document.getElementById('editModal').style.display = 'block';
      }

      async function saveProductEdit() {
        token = localStorage.getItem('token') || token;
        const payload = {};
        
        const name = document.getElementById('editName').value;
        const image = document.getElementById('editImage').value;
        const price = document.getElementById('editPrice').value;
        const stock = document.getElementById('editStock').value;
        const description = document.getElementById('editDesc').value;
        
        if (name) payload.name = name;
        if (image) payload.image = image;
        if (price) payload.price = Number(price);
        if (stock) payload.stock = Number(stock);
        if (description) payload.description = description;
        try {
          const res = await fetch(`${API_BASE}/products/${productId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          alert('Product updated');
          loadProducts();
        } catch (err) {
          console.error(err);
          alert('Failed to update product');
        }
      }

      async function addToCart(productId) {
        token = localStorage.getItem("token") || token;
        if (!token) return alert("Please login first!");

        try {
          const res = await fetch(`${API_BASE}/cart/add`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({ productId }),
          });
          const data = await res.json();
          alert(data.message || "Product added to cart!");
        } catch (err) {
          alert("Failed to add product to cart.");
          console.error(err);
        }
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("userRole");
        token = "";
        userRole = "";
        document.getElementById("adminSection").style.display = "none";
        alert("Logged out!");
      }

      // Load products when page loads
      window.onload = loadProducts;
    </script>
  </body>
</html>
