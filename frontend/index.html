<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üõç Simple Shop</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>üõç Simple Shop</h1>
      <nav>
        <button onclick="loadProducts()">Home</button>
        <button onclick="window.location.href='cart.html'">Cart</button>
        <button onclick="logout()">Logout</button>
      </nav>
    </header>

    <section class="auth-section">
      <h2>Login / Signup</h2>
      <div class="auth">
        <input type="text" id="name" placeholder="Full Name (for Signup)" />
        <input type="text" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <div class="auth-buttons">
          <button onclick="login()">Login</button>
          <button onclick="signup()">Signup</button>
        </div>
      </div>
    </section>

    <section>
      <h2>Products</h2>
      <div id="productList" class="products"></div>
    </section>

    <section class="admin" id="adminSection" style="display: none;">
      <h2>Admin: Add Product</h2>
      <div class="add-product">
        <input type="text" id="pname" placeholder="Product Name" />
        <input type="number" id="pprice" placeholder="Price (‚Çπ)" />
        <input type="number" id="pstock" placeholder="Stock" />
        <input type="text" id="pdesc" placeholder="Description" />
        <button onclick="addProduct()">Add Product</button>
      </div>
    </section>

    <footer>
      <p>¬© 2025 Simple Shop | Built by Yashwanth Raj KS</p>
    </footer>

    <script>
      const API_BASE = "http://localhost:5000/api";
      let token = localStorage.getItem("token") || "";
      let userRole = localStorage.getItem("userRole") || "";

      async function signup() {
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        if (!name || !email || !password)
          return alert("Please fill all fields.");
        const res = await fetch(`${API_BASE}/auth/signup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password }),
        });
        const data = await res.json();
        alert(data.message || "Signup successful! Please login.");
      }

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        if (!email || !password)
          return alert("Please enter email and password.");
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (data.token) {
          token = data.token;
          userRole = data.user.role;
          localStorage.setItem("token", token);
          localStorage.setItem("userRole", userRole);
          alert(`Welcome ${data.user.name || data.user.email}!`);
          loadProducts();
          if (userRole === "admin")
            document.getElementById("adminSection").style.display = "block";
        } else {
          alert(data.message || "Login failed");
        }
      }

      async function loadProducts() {
        try {
          const res = await fetch(`${API_BASE}/products`);
          const products = await res.json();
          const productList = document.getElementById("productList");
          productList.innerHTML = products.map(p => {
            // Determine image path based on product name
            let imgPath = "./images/default.jpg";
            const nameLower = p.name.toLowerCase();
            
            // Map product names to images
            const imageMap = {
              'airpods': 'airpods.jpg',
              'fitbit': 'fitbit.jpg',
              'iphone': 'iphone.jpg',
              'sony': 'sony.jpg'
            };
            
            // Find matching image
            for (const [keyword, image] of Object.entries(imageMap)) {
              if (nameLower.includes(keyword)) {
                imgPath = `./images/${image}`;
                break;
              }
            }
            
            return `
              <div class="product-card">
                <div class="img-container">
                  <img src="${imgPath}" 
                       alt="${p.name}" 
                       class="product-image"
                       loading="lazy"
                       onerror="this.onerror=null; this.src='./images/default.jpg';">
                </div>
                <div class="product-details">
                  <h3>${p.name}</h3>
                  <p class="price">‚Çπ${p.price}</p>
                  <p>Stock: ${p.stock || 0}</p>
                  <p class="desc">${p.description || ""}</p>
                  <button onclick="addToCart('${p._id}')">Add to Cart</button>
                </div>
              </div>
            `;
          }).join("");
        } catch (error) {
          console.error("Error loading products:", error);
          productList.innerHTML = '<p class="error">Failed to load products. Please try again.</p>';
        }
      }
            
            productList.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading products:", error);
          alert("Failed to load products. Please try again.");
        }
      };
          })
          .join("");
      }

      async function addProduct() {
        token = localStorage.getItem("token") || token;
        if (userRole !== "admin") return alert("Only admin can add products!");
        const name = document.getElementById("pname").value;
        const price = document.getElementById("pprice").value;
        const stock = document.getElementById("pstock").value;
        const description = document.getElementById("pdesc").value;

        await fetch(`${API_BASE}/products`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ name, price, stock, description }),
        });
        alert("Product added successfully!");
        loadProducts();
      }

      async function addToCart(productId) {
        token = localStorage.getItem("token") || token;
        if (!token) return alert("Please login first!");
        await fetch(`${API_BASE}/cart/add`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ productId }),
        });
        alert("Product added to cart!");
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("userRole");
        token = "";
        userRole = "";
        document.getElementById("adminSection").style.display = "none";
        alert("Logged out!");
      }

      loadProducts();
    </script>
  </body>
</html>
